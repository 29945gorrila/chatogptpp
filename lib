
local Cohoes = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Theme
local Theme = {
    Background = Color3.fromRGB(10, 10, 10),
    Secondary = Color3.fromRGB(18, 18, 18),
    Tertiary = Color3.fromRGB(30, 30, 30),
    Accent = Color3.fromRGB(255, 255, 255),
    AccentDark = Color3.fromRGB(200, 200, 200),
    Text = Color3.fromRGB(255, 255, 255),
    TextDark = Color3.fromRGB(120, 120, 120),
    Success = Color3.fromRGB(100, 255, 150),
    Warning = Color3.fromRGB(255, 200, 100),
    Error = Color3.fromRGB(255, 100, 100),
    Border = Color3.fromRGB(60, 60, 60),
    Glow = Color3.fromRGB(255, 255, 255),
    Shadow = Color3.fromRGB(0, 0, 0)
}

Cohoes.Theme = Theme

-- Helper function to add glow effect
local function AddGlow(element, color, size, transparency)
    local glow = Instance.new("ImageLabel")
    glow.Name = "Glow"
    glow.BackgroundTransparency = 1
    glow.Size = UDim2.new(1, size or 20, 1, size or 20)
    glow.Position = UDim2.new(0.5, 0, 0.5, 0)
    glow.AnchorPoint = Vector2.new(0.5, 0.5)
    glow.Image = "rbxassetid://5028857084"
    glow.ImageColor3 = color or Theme.Glow
    glow.ImageTransparency = transparency or 0.7
    glow.ZIndex = element.ZIndex - 1
    glow.Parent = element
    return glow
end

-- Helper function to add drop shadow
local function AddShadow(element, transparency)
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.BackgroundTransparency = 1
    shadow.Size = UDim2.new(1, 30, 1, 30)
    shadow.Position = UDim2.new(0.5, 0, 0.5, 2)
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.Image = "rbxassetid://5028857084"
    shadow.ImageColor3 = Theme.Shadow
    shadow.ImageTransparency = transparency or 0.5
    shadow.ZIndex = element.ZIndex - 1
    shadow.Parent = element
    return shadow
end

-- Smooth tween helper
function Cohoes:tween(obj, properties, easingStyle, time)
    local tween = TweenService:Create(
        obj,
        TweenInfo.new(
            time or 0.25,
            easingStyle or Enum.EasingStyle.Quint,
            Enum.EasingDirection.InOut,
            0,
            false,
            0
        ),
        properties
    )
    tween:Play()
    return tween
end

-- Screen GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CohoesUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local function ProtectGui()
    if syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
        ScreenGui.Parent = game.CoreGui
    elseif gethui then
        ScreenGui.Parent = gethui()
    else
        ScreenGui.Parent = game.CoreGui
    end
end
ProtectGui()

-- Dropdown overlay container
local OverlayContainer = Instance.new("Frame")
OverlayContainer.Name = "OverlayContainer"
OverlayContainer.Size = UDim2.new(1, 0, 1, 0)
OverlayContainer.BackgroundTransparency = 1
OverlayContainer.ZIndex = 100
OverlayContainer.Parent = ScreenGui

-- Notification System
local NotifHolder = Instance.new("Frame")
NotifHolder.Name = "Notifications"
NotifHolder.Size = UDim2.new(0, 300, 1, -40)
NotifHolder.Position = UDim2.new(1, -310, 0, 20)
NotifHolder.BackgroundTransparency = 1
NotifHolder.ZIndex = 200
NotifHolder.Parent = ScreenGui

local NotifLayout = Instance.new("UIListLayout")
NotifLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifLayout.Padding = UDim.new(0, 6)
NotifLayout.VerticalAlignment = Enum.VerticalAlignment.Top
NotifLayout.Parent = NotifHolder

function Cohoes:Notify(options)
    local title = options.Title or "Notification"
    local message = options.Message or ""
    local duration = options.Duration or 3
    
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(1, 0, 0, 55)
    notif.BackgroundColor3 = Theme.Secondary
    notif.BorderSizePixel = 0
    notif.Position = UDim2.new(1, 20, 0, 0)
    notif.ZIndex = 201
    notif.Parent = NotifHolder
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = notif
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Theme.Border
    stroke.Thickness = 1
    stroke.Parent = notif
    
    local glow = AddGlow(notif, Theme.Accent, 25, 0.5)
    
    -- Pulsing animation
    spawn(function()
        while notif.Parent do
            Cohoes:tween(glow, {ImageTransparency = 0.3}, Enum.EasingStyle.Sine, 1)
            wait(1)
            if notif.Parent then
                Cohoes:tween(glow, {ImageTransparency = 0.6}, Enum.EasingStyle.Sine, 1)
                wait(1)
            end
        end
    end)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -16, 0, 20)
    titleLabel.Position = UDim2.new(0, 8, 0, 6)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.Arcade
    titleLabel.Text = title
    titleLabel.TextColor3 = Theme.Text
    titleLabel.TextSize = 12
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.ZIndex = 202
    titleLabel.Parent = notif
    
    local msgLabel = Instance.new("TextLabel")
    msgLabel.Size = UDim2.new(1, -16, 0, 18)
    msgLabel.Position = UDim2.new(0, 8, 0, 26)
    msgLabel.BackgroundTransparency = 1
    msgLabel.Font = Enum.Font.Arcade
    msgLabel.Text = message
    msgLabel.TextColor3 = Theme.TextDark
    msgLabel.TextSize = 10
    msgLabel.TextXAlignment = Enum.TextXAlignment.Left
    msgLabel.TextTruncate = Enum.TextTruncate.AtEnd
    msgLabel.ZIndex = 202
    msgLabel.Parent = notif
    
    local progressBg = Instance.new("Frame")
    progressBg.Size = UDim2.new(1, 0, 0, 2)
    progressBg.Position = UDim2.new(0, 0, 1, -2)
    progressBg.BackgroundColor3 = Theme.Tertiary
    progressBg.BorderSizePixel = 0
    progressBg.ZIndex = 202
    progressBg.Parent = notif
    
    local progress = Instance.new("Frame")
    progress.Size = UDim2.new(1, 0, 1, 0)
    progress.BackgroundColor3 = Theme.Accent
    progress.BorderSizePixel = 0
    progress.ZIndex = 203
    progress.Parent = progressBg
    
    Cohoes:tween(notif, {Position = UDim2.new(0, 0, 0, 0)}, Enum.EasingStyle.Quart, 0.3)
    Cohoes:tween(progress, {Size = UDim2.new(0, 0, 1, 0)}, Enum.EasingStyle.Linear, duration)
    
    task.delay(duration, function()
        Cohoes:tween(notif, {Position = UDim2.new(1, 20, 0, 0)}, Enum.EasingStyle.Quart, 0.3)
        task.wait(0.35)
        notif:Destroy()
    end)
end


-- Window Creation
function Cohoes:CreateWindow(options)
    local Window = {}
    
    local title = options.Title or "Cohoes UI"
    local size = options.Size or {500, 400}
    local toggleKey = options.ToggleKey or Enum.KeyCode.RightShift
    
    local Main = Instance.new("Frame")
    Main.Name = "MainWindow"
    Main.Size = UDim2.new(0, size[1], 0, size[2])
    Main.Position = UDim2.new(0.5, -size[1]/2, 0.5, -size[2]/2)
    Main.BackgroundColor3 = Theme.Background
    Main.BorderSizePixel = 0
    Main.Parent = ScreenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = Main
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Theme.Border
    mainStroke.Thickness = 1
    mainStroke.Parent = Main
    
    local mainShadow = AddShadow(Main, 0.2)
    mainShadow.Size = UDim2.new(1, 60, 1, 60)
    
    -- Header
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 32)
    Header.BackgroundColor3 = Theme.Secondary
    Header.BorderSizePixel = 0
    Header.Parent = Main
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 6)
    headerCorner.Parent = Header
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 10)
    headerFix.Position = UDim2.new(0, 0, 1, -10)
    headerFix.BackgroundColor3 = Theme.Secondary
    headerFix.BorderSizePixel = 0
    headerFix.Parent = Header
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -70, 1, 0)
    titleLabel.Position = UDim2.new(0, 12, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.Arcade
    titleLabel.Text = string.upper(title)
    titleLabel.TextColor3 = Theme.Text
    titleLabel.TextSize = 12
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = Header
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 20, 0, 20)
    closeBtn.Position = UDim2.new(1, -28, 0.5, -10)
    closeBtn.BackgroundColor3 = Theme.Tertiary
    closeBtn.BorderSizePixel = 0
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Theme.TextDark
    closeBtn.TextSize = 14
    closeBtn.Parent = Header
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 4)
    closeBtnCorner.Parent = closeBtn
    
    local closeBtnGlow = AddGlow(closeBtn, Theme.Error, 15, 1)
    
    closeBtn.MouseEnter:Connect(function()
        Cohoes:tween(closeBtn, {BackgroundColor3 = Theme.Error}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(closeBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.15)
    end)
    closeBtn.MouseLeave:Connect(function()
        Cohoes:tween(closeBtn, {BackgroundColor3 = Theme.Tertiary}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(closeBtnGlow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
    end)
    closeBtn.MouseButton1Click:Connect(function()
        Main.Visible = false
    end)
    
    -- Minimize button
    local minBtn = Instance.new("TextButton")
    minBtn.Size = UDim2.new(0, 20, 0, 20)
    minBtn.Position = UDim2.new(1, -52, 0.5, -10)
    minBtn.BackgroundColor3 = Theme.Tertiary
    minBtn.BorderSizePixel = 0
    minBtn.Font = Enum.Font.GothamBold
    minBtn.Text = "−"
    minBtn.TextColor3 = Theme.TextDark
    minBtn.TextSize = 14
    minBtn.Parent = Header
    
    local minBtnCorner = Instance.new("UICorner")
    minBtnCorner.CornerRadius = UDim.new(0, 4)
    minBtnCorner.Parent = minBtn
    
    local minBtnGlow = AddGlow(minBtn, Theme.Warning, 15, 1)
    
    minBtn.MouseEnter:Connect(function()
        Cohoes:tween(minBtn, {BackgroundColor3 = Theme.Warning}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(minBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.15)
    end)
    minBtn.MouseLeave:Connect(function()
        Cohoes:tween(minBtn, {BackgroundColor3 = Theme.Tertiary}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(minBtnGlow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
    end)
    
    -- Tab sidebar
    local TabSidebar = Instance.new("Frame")
    TabSidebar.Name = "TabSidebar"
    TabSidebar.Size = UDim2.new(0, 100, 1, -40)
    TabSidebar.Position = UDim2.new(0, 4, 0, 36)
    TabSidebar.BackgroundColor3 = Theme.Secondary
    TabSidebar.BorderSizePixel = 0
    TabSidebar.Parent = Main
    
    local sidebarCorner = Instance.new("UICorner")
    sidebarCorner.CornerRadius = UDim.new(0, 4)
    sidebarCorner.Parent = TabSidebar
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 2)
    tabLayout.Parent = TabSidebar
    
    local tabPadding = Instance.new("UIPadding")
    tabPadding.PaddingTop = UDim.new(0, 4)
    tabPadding.PaddingLeft = UDim.new(0, 4)
    tabPadding.PaddingRight = UDim.new(0, 4)
    tabPadding.Parent = TabSidebar
    
    -- Content container
    local ContentContainer = Instance.new("Frame")
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Size = UDim2.new(1, -116, 1, -40)
    ContentContainer.Position = UDim2.new(0, 110, 0, 36)
    ContentContainer.BackgroundTransparency = 1
    ContentContainer.ClipsDescendants = true
    ContentContainer.Parent = Main
    
    -- Dragging
    local dragging, dragStart, startPos = false, nil, nil
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    -- Toggle key
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.KeyCode == toggleKey then
            Main.Visible = not Main.Visible
        end
    end)
    
    -- Minimize
    local minimized = false
    minBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            Cohoes:tween(Main, {Size = UDim2.new(0, size[1], 0, 32)}, Enum.EasingStyle.Quart, 0.3)
            ContentContainer.Visible = false
            TabSidebar.Visible = false
        else
            Cohoes:tween(Main, {Size = UDim2.new(0, size[1], 0, size[2])}, Enum.EasingStyle.Quart, 0.3)
            task.wait(0.15)
            ContentContainer.Visible = true
            TabSidebar.Visible = true
        end
    end)
    
    local Tabs = {}
    local CurrentTab = nil
    local TabCount = 0
    
    function Window:CreateTab(name)
        local Tab = {}
        TabCount = TabCount + 1
        
        local tabBtn = Instance.new("TextButton")
        tabBtn.Name = name
        tabBtn.Size = UDim2.new(1, 0, 0, 28)
        tabBtn.BackgroundColor3 = Theme.Tertiary
        tabBtn.BackgroundTransparency = 1
        tabBtn.BorderSizePixel = 0
        tabBtn.Font = Enum.Font.Arcade
        tabBtn.Text = string.upper(name)
        tabBtn.TextColor3 = Theme.TextDark
        tabBtn.TextSize = 10
        tabBtn.LayoutOrder = TabCount
        tabBtn.Parent = TabSidebar
        
        local tabBtnCorner = Instance.new("UICorner")
        tabBtnCorner.CornerRadius = UDim.new(0, 4)
        tabBtnCorner.Parent = tabBtn
        
        local tabBtnGlow = AddGlow(tabBtn, Theme.Accent, 20, 1)
        
        local page = Instance.new("ScrollingFrame")
        page.Name = name .. "Page"
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1
        page.BorderSizePixel = 0
        page.ScrollBarThickness = 3
        page.ScrollBarImageColor3 = Theme.TextDark
        page.CanvasSize = UDim2.new(0, 0, 0, 0)
        page.Visible = false
        page.Parent = ContentContainer
        
        local pageLayout = Instance.new("UIListLayout")
        pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
        pageLayout.Padding = UDim.new(0, 6)
        pageLayout.Parent = page
        
        -- BUGFIX: Proper canvas size updating
        local function updateCanvasSize()
            task.wait(0.1) -- Small delay to ensure layout has updated
            local contentSize = pageLayout.AbsoluteContentSize.Y
            page.CanvasSize = UDim2.new(0, 0, 0, contentSize + 10)
        end
        
        pageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)
        
        Tabs[name] = {btn = tabBtn, page = page, layout = pageLayout, glow = tabBtnGlow, updateCanvas = updateCanvasSize}
        
        tabBtn.MouseButton1Click:Connect(function()
            if CurrentTab and Tabs[CurrentTab] then
                Cohoes:tween(Tabs[CurrentTab].btn, {TextColor3 = Theme.TextDark, BackgroundTransparency = 1}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(Tabs[CurrentTab].glow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.2)
                Tabs[CurrentTab].page.Visible = false
            end
            CurrentTab = name
            Cohoes:tween(tabBtn, {TextColor3 = Theme.Text, BackgroundTransparency = 0}, Enum.EasingStyle.Quart, 0.2)
            Cohoes:tween(tabBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.2)
            page.Visible = true
            -- BUGFIX: Update canvas size when tab is shown
            updateCanvasSize()
        end)
        
        tabBtn.MouseEnter:Connect(function()
            if CurrentTab ~= name then
                Cohoes:tween(tabBtn, {BackgroundTransparency = 0.5}, Enum.EasingStyle.Quart, 0.15)
            end
        end)
        tabBtn.MouseLeave:Connect(function()
            if CurrentTab ~= name then
                Cohoes:tween(tabBtn, {BackgroundTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
            end
        end)
        
        -- BUGFIX: Ensure first tab is properly activated
        if TabCount == 1 then
            task.wait(0.05) -- Small delay to ensure UI is ready
            tabBtn.TextColor3 = Theme.Text
            tabBtn.BackgroundTransparency = 0
            tabBtnGlow.ImageTransparency = 0.4
            page.Visible = true
            CurrentTab = name
            updateCanvasSize()
        end
        
        local SectionOrder = 0
        
        function Tab:CreateSection(sectionName)
            SectionOrder = SectionOrder + 1
            
            local section = Instance.new("Frame")
            section.Name = sectionName
            section.Size = UDim2.new(1, 0, 0, 0)
            section.AutomaticSize = Enum.AutomaticSize.Y
            section.BackgroundColor3 = Theme.Secondary
            section.BorderSizePixel = 0
            section.LayoutOrder = SectionOrder
            section.Parent = page
            
            local sCorner = Instance.new("UICorner")
            sCorner.CornerRadius = UDim.new(0, 4)
            sCorner.Parent = section
            
            AddGlow(section, Theme.Accent, 10, 0.9)
            
            local sPadding = Instance.new("UIPadding")
            sPadding.PaddingLeft = UDim.new(0, 10)
            sPadding.PaddingRight = UDim.new(0, 10)
            sPadding.PaddingTop = UDim.new(0, 8)
            sPadding.PaddingBottom = UDim.new(0, 8)
            sPadding.Parent = section
            
            local sLayout = Instance.new("UIListLayout")
            sLayout.SortOrder = Enum.SortOrder.LayoutOrder
            sLayout.Padding = UDim.new(0, 6)
            sLayout.Parent = section
            
            local sLabel = Instance.new("TextLabel")
            sLabel.Size = UDim2.new(1, 0, 0, 16)
            sLabel.BackgroundTransparency = 1
            sLabel.Font = Enum.Font.Arcade
            sLabel.Text = string.upper(sectionName)
            sLabel.TextColor3 = Theme.TextDark
            sLabel.TextSize = 10
            sLabel.TextXAlignment = Enum.TextXAlignment.Left
            sLabel.LayoutOrder = 0
            sLabel.Parent = section
            
            -- BUGFIX: Update canvas when section content changes
            sLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                task.wait(0.05)
                if Tabs[CurrentTab] and Tabs[CurrentTab].updateCanvas then
                    Tabs[CurrentTab].updateCanvas()
                end
            end)
            
            return section, sLayout
        end
        
        -- Toggle with glow effects
        function Tab:CreateToggle(options)
            local name = options.Name or "Toggle"
            local default = options.Default or false
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 26)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -50, 1, 0)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(0, 38, 0, 18)
            btn.Position = UDim2.new(1, -38, 0.5, -9)
            btn.BackgroundColor3 = default and Theme.Accent or Theme.Tertiary
            btn.BorderSizePixel = 0
            btn.Text = ""
            btn.Parent = container
            
            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(1, 0)
            btnCorner.Parent = btn
            
            local btnGlow = AddGlow(btn, Theme.Accent, 12, default and 0.5 or 1)
            
            local knob = Instance.new("Frame")
            knob.Size = UDim2.new(0, 14, 0, 14)
            knob.Position = default and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)
            knob.BackgroundColor3 = default and Theme.Background or Theme.TextDark
            knob.BorderSizePixel = 0
            knob.Parent = btn
            
            local knobCorner = Instance.new("UICorner")
            knobCorner.CornerRadius = UDim.new(1, 0)
            knobCorner.Parent = knob
            
            local knobGlow = AddGlow(knob, Theme.Accent, 8, 1)
            
            local enabled = default
            
            btn.MouseButton1Click:Connect(function()
                enabled = not enabled
                Cohoes:tween(btn, {BackgroundColor3 = enabled and Theme.Accent or Theme.Tertiary}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(knob, {
                    Position = enabled and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7),
                    BackgroundColor3 = enabled and Theme.Background or Theme.TextDark
                }, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(btnGlow, {ImageTransparency = enabled and 0.5 or 1}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(knobGlow, {ImageTransparency = enabled and 0.6 or 1}, Enum.EasingStyle.Quart, 0.2)
                callback(enabled)
            end)
            
            local Toggle = {}
            function Toggle:Set(value)
                enabled = value
                Cohoes:tween(btn, {BackgroundColor3 = enabled and Theme.Accent or Theme.Tertiary}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(knob, {
                    Position = enabled and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7),
                    BackgroundColor3 = enabled and Theme.Background or Theme.TextDark
                }, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(btnGlow, {ImageTransparency = enabled and 0.5 or 1}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(knobGlow, {ImageTransparency = enabled and 0.6 or 1}, Enum.EasingStyle.Quart, 0.2)
                callback(enabled)
            end
            function Toggle:Get() return enabled end
            
            return Toggle
        end
        
        -- Slider with glowing track
        function Tab:CreateSlider(options)
            local name = options.Name or "Slider"
            local min = options.Min or 0
            local max = options.Max or 100
            local default = options.Default or min
            local decimals = options.Decimals or 2
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 38)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -70, 0, 16)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local valueBox = Instance.new("TextBox")
            valueBox.Size = UDim2.new(0, 55, 0, 18)
            valueBox.Position = UDim2.new(1, -55, 0, 0)
            valueBox.BackgroundColor3 = Theme.Tertiary
            valueBox.BorderSizePixel = 0
            valueBox.Font = Enum.Font.Arcade
            valueBox.Text = tostring(default)
            valueBox.TextColor3 = Theme.Text
            valueBox.TextSize = 10
            valueBox.ClearTextOnFocus = true
            valueBox.Parent = container
            
            local valueBoxCorner = Instance.new("UICorner")
            valueBoxCorner.CornerRadius = UDim.new(0, 4)
            valueBoxCorner.Parent = valueBox
            
            local valueBoxStroke = Instance.new("UIStroke")
            valueBoxStroke.Color = Theme.Border
            valueBoxStroke.Thickness = 1
            valueBoxStroke.Parent = valueBox
            
            local track = Instance.new("Frame")
            track.Size = UDim2.new(1, 0, 0, 4)
            track.Position = UDim2.new(0, 0, 0, 26)
            track.BackgroundColor3 = Theme.Tertiary
            track.BorderSizePixel = 0
            track.Parent = container
            
            local trackCorner = Instance.new("UICorner")
            trackCorner.CornerRadius = UDim.new(1, 0)
            trackCorner.Parent = track
            
            local fill = Instance.new("Frame")
            fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
            fill.BackgroundColor3 = Theme.Accent
            fill.BorderSizePixel = 0
            fill.Parent = track
            
            local fillCorner = Instance.new("UICorner")
            fillCorner.CornerRadius = UDim.new(1, 0)
            fillCorner.Parent = fill
            
            local fillGlow = AddGlow(fill, Theme.Accent, 8, 0.6)
            
            local knob = Instance.new("Frame")
            knob.Size = UDim2.new(0, 12, 0, 12)
            knob.Position = UDim2.new((default - min) / (max - min), -6, 0.5, -6)
            knob.BackgroundColor3 = Theme.Accent
            knob.BorderSizePixel = 0
            knob.Parent = track
            
            local knobCorner = Instance.new("UICorner")
            knobCorner.CornerRadius = UDim.new(1, 0)
            knobCorner.Parent = knob
            
            local knobGlow = AddGlow(knob, Theme.Accent, 10, 0.4)
            
            local currentValue = default
            local isDragging = false
            
            local function formatValue(val)
                return string.format("%." .. decimals .. "f", val)
            end
            
            local function updateVisual(val)
                local pos = (val - min) / (max - min)
                fill.Size = UDim2.new(pos, 0, 1, 0)
                knob.Position = UDim2.new(pos, -6, 0.5, -6)
                valueBox.Text = formatValue(val)
            end
            
            local function update(input)
                local pos = math.clamp((input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X, 0, 1)
                local mult = math.pow(10, decimals)
                currentValue = math.floor((min + (max - min) * pos) * mult) / mult
                updateVisual(currentValue)
                callback(currentValue)
            end
            
            track.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = true
                    update(input)
                end
            end)
            
            track.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    isDragging = false
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    update(input)
                end
            end)
            
            valueBox.FocusLost:Connect(function(enterPressed)
                local val = tonumber(valueBox.Text)
                if val then
                    val = math.clamp(val, min, max)
                    currentValue = val
                    updateVisual(val)
                    callback(val)
                else
                    valueBox.Text = formatValue(currentValue)
                end
            end)
            
            local Slider = {}
            function Slider:Set(value)
                currentValue = math.clamp(value, min, max)
                updateVisual(currentValue)
                callback(currentValue)
            end
            function Slider:Get() return currentValue end
            
            return Slider
        end
        
        -- Input/Textbox
        function Tab:CreateInput(options)
            local name = options.Name or "Input"
            local default = options.Default or ""
            local placeholder = options.Placeholder or ""
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            local numeric = options.Numeric or false
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 26)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -70, 1, 0)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local box = Instance.new("TextBox")
            box.Size = UDim2.new(0, 60, 0, 20)
            box.Position = UDim2.new(1, -60, 0.5, -10)
            box.BackgroundColor3 = Theme.Tertiary
            box.BorderSizePixel = 0
            box.Font = Enum.Font.Arcade
            box.Text = tostring(default)
            box.PlaceholderText = placeholder
            box.TextColor3 = Theme.Text
            box.PlaceholderColor3 = Theme.TextDark
            box.TextSize = 10
            box.ClearTextOnFocus = false
            box.Parent = container
            
            local boxCorner = Instance.new("UICorner")
            boxCorner.CornerRadius = UDim.new(0, 4)
            boxCorner.Parent = box
            
            local boxStroke = Instance.new("UIStroke")
            boxStroke.Color = Theme.Border
            boxStroke.Thickness = 1
            boxStroke.Parent = box
            
            box.FocusLost:Connect(function()
                if numeric then
                    local val = tonumber(box.Text)
                    if val then
                        callback(val)
                    else
                        box.Text = tostring(default)
                    end
                else
                    callback(box.Text)
                end
            end)
            
            local Input = {}
            function Input:Set(value)
                box.Text = tostring(value)
                callback(value)
            end
            function Input:Get()
                return numeric and tonumber(box.Text) or box.Text
            end
            
            return Input
        end
        
        -- Button with glow
        function Tab:CreateButton(options)
            local name = options.Name or "Button"
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 28)
            btn.BackgroundColor3 = Theme.Tertiary
            btn.BorderSizePixel = 0
            btn.Font = Enum.Font.Arcade
            btn.Text = name
            btn.TextColor3 = Theme.Text
            btn.TextSize = 10
            btn.LayoutOrder = order
            btn.Parent = parent
            
            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(0, 4)
            btnCorner.Parent = btn
            
            local btnStroke = Instance.new("UIStroke")
            btnStroke.Color = Theme.Border
            btnStroke.Thickness = 1
            btnStroke.Parent = btn
            
            local btnGlow = AddGlow(btn, Theme.Accent, 15, 1)
            
            btn.MouseEnter:Connect(function()
                Cohoes:tween(btn, {BackgroundColor3 = Theme.Accent, TextColor3 = Theme.Background}, Enum.EasingStyle.Quart, 0.15)
                Cohoes:tween(btnGlow, {ImageTransparency = 0.5}, Enum.EasingStyle.Quart, 0.15)
            end)
            btn.MouseLeave:Connect(function()
                Cohoes:tween(btn, {BackgroundColor3 = Theme.Tertiary, TextColor3 = Theme.Text}, Enum.EasingStyle.Quart, 0.15)
                Cohoes:tween(btnGlow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
            end)
            btn.MouseButton1Click:Connect(callback)
        end
        
        -- FIXED DROPDOWN - Works infinitely!
        function Tab:CreateDropdown(options)
            local name = options.Name or "Dropdown"
            local optionsList = options.Options or {}
            local default = options.Default or optionsList[1] or ""
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 26)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(0.45, 0, 1, 0)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local dropBtn = Instance.new("TextButton")
            dropBtn.Size = UDim2.new(0.55, -4, 0, 22)
            dropBtn.Position = UDim2.new(0.45, 4, 0.5, -11)
            dropBtn.BackgroundColor3 = Theme.Tertiary
            dropBtn.BorderSizePixel = 0
            dropBtn.Font = Enum.Font.Arcade
            dropBtn.Text = default .. " ▼"
            dropBtn.TextColor3 = Theme.Text
            dropBtn.TextSize = 9
            dropBtn.Parent = container
            
            local dropBtnCorner = Instance.new("UICorner")
            dropBtnCorner.CornerRadius = UDim.new(0, 4)
            dropBtnCorner.Parent = dropBtn
            
            local dropBtnStroke = Instance.new("UIStroke")
            dropBtnStroke.Color = Theme.Border
            dropBtnStroke.Thickness = 1
            dropBtnStroke.Parent = dropBtn
            
            -- Dropdown list in overlay
            local dropList = Instance.new("Frame")
            dropList.Size = UDim2.new(0, 0, 0, 0)
            dropList.BackgroundColor3 = Theme.Secondary
            dropList.BorderSizePixel = 0
            dropList.Visible = false
            dropList.ZIndex = 101
            dropList.Parent = OverlayContainer
            
            local dropListCorner = Instance.new("UICorner")
            dropListCorner.CornerRadius = UDim.new(0, 4)
            dropListCorner.Parent = dropList
            
            local dropListStroke = Instance.new("UIStroke")
            dropListStroke.Color = Theme.Border
            dropListStroke.Thickness = 1
            dropListStroke.Parent = dropList
            
            AddShadow(dropList, 0.3)
            
            local dropScroll = Instance.new("ScrollingFrame")
            dropScroll.Size = UDim2.new(1, 0, 1, 0)
            dropScroll.BackgroundTransparency = 1
            dropScroll.BorderSizePixel = 0
            dropScroll.ScrollBarThickness = 2
            dropScroll.ScrollBarImageColor3 = Theme.TextDark
            dropScroll.CanvasSize = UDim2.new(0, 0, 0, #optionsList * 24)
            dropScroll.ZIndex = 102
            dropScroll.Parent = dropList
            
            local dropLayout = Instance.new("UIListLayout")
            dropLayout.SortOrder = Enum.SortOrder.LayoutOrder
            dropLayout.Parent = dropScroll
            
            local currentValue = default
            local isOpen = false
            
            local function createOptions()
                for _, child in pairs(dropScroll:GetChildren()) do
                    if child:IsA("TextButton") then child:Destroy() end
                end
                
                for i, option in ipairs(optionsList) do
                    local optBtn = Instance.new("TextButton")
                    optBtn.Size = UDim2.new(1, 0, 0, 24)
                    optBtn.BackgroundColor3 = Theme.Tertiary
                    optBtn.BackgroundTransparency = 1
                    optBtn.BorderSizePixel = 0
                    optBtn.Font = Enum.Font.Arcade
                    optBtn.Text = option
                    optBtn.TextColor3 = Theme.Text
                    optBtn.TextSize = 9
                    optBtn.LayoutOrder = i
                    optBtn.ZIndex = 103
                    optBtn.Parent = dropScroll
                    
                    optBtn.MouseEnter:Connect(function()
                        Cohoes:tween(optBtn, {BackgroundTransparency = 0}, Enum.EasingStyle.Quad, 0.1)
                    end)
                    optBtn.MouseLeave:Connect(function()
                        Cohoes:tween(optBtn, {BackgroundTransparency = 1}, Enum.EasingStyle.Quad, 0.1)
                    end)
                    
                    -- CRITICAL FIX: Use MouseButton1Down instead of Click
                    optBtn.MouseButton1Down:Connect(function()
                        currentValue = option
                        dropBtn.Text = option .. " ▼"
                        callback(option)
                        -- Small delay ensures callback fires before closing
                        task.wait(0.05)
                        isOpen = false
                        dropList.Visible = false
                    end)
                end
                
                dropScroll.CanvasSize = UDim2.new(0, 0, 0, #optionsList * 24)
            end
            
            createOptions()
            
            local function updateDropPosition()
                local absPos = dropBtn.AbsolutePosition
                local absSize = dropBtn.AbsoluteSize
                dropList.Position = UDim2.new(0, absPos.X, 0, absPos.Y + absSize.Y + 2)
                dropList.Size = UDim2.new(0, absSize.X, 0, math.min(#optionsList * 24, 150))
            end
            
            dropBtn.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                if isOpen then
                    updateDropPosition()
                    dropList.Visible = true
                else
                    dropList.Visible = false
                end
            end)
            
            -- FIXED: Better click-outside detection
            local clickConnection
            clickConnection = UserInputService.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 and isOpen then
                    task.wait()
                    
                    if not isOpen then return end
                    
                    local mousePos = UserInputService:GetMouseLocation()
                    local listPos = dropList.AbsolutePosition
                    local listSize = dropList.AbsoluteSize
                    local btnPos = dropBtn.AbsolutePosition
                    local btnSize = dropBtn.AbsoluteSize
                    
                    local inList = mousePos.X >= listPos.X and mousePos.X <= listPos.X + listSize.X and
                                   mousePos.Y >= listPos.Y and mousePos.Y <= listPos.Y + listSize.Y
                    local inBtn = mousePos.X >= btnPos.X and mousePos.X <= btnPos.X + btnSize.X and
                                  mousePos.Y >= btnPos.Y and mousePos.Y <= btnPos.Y + btnSize.Y
                    
                    if not inList and not inBtn then
                        isOpen = false
                        dropList.Visible = false
                    end
                end
            end)
            
            local Dropdown = {}
            function Dropdown:Set(value)
                currentValue = value
                dropBtn.Text = value .. " ▼"
                callback(value)
            end
            function Dropdown:Get() return currentValue end
            function Dropdown:Refresh(newOptions)
                optionsList = newOptions
                createOptions()
            end
            
            return Dropdown
        end
        
        -- FIXED COLOR PICKER with smooth dragging and dynamic glow
        function Tab:CreateColorPicker(options)
            local name = options.Name or "Color"
            local default = options.Default or Color3.fromRGB(255, 255, 255)
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 26)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -40, 1, 0)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local colorBtn = Instance.new("TextButton")
            colorBtn.Size = UDim2.new(0, 32, 0, 20)
            colorBtn.Position = UDim2.new(1, -32, 0.5, -10)
            colorBtn.BackgroundColor3 = default
            colorBtn.BorderSizePixel = 0
            colorBtn.Text = ""
            colorBtn.Parent = container
            
            local colorBtnCorner = Instance.new("UICorner")
            colorBtnCorner.CornerRadius = UDim.new(0, 4)
            colorBtnCorner.Parent = colorBtn
            
            local colorBtnStroke = Instance.new("UIStroke")
            colorBtnStroke.Color = Theme.Border
            colorBtnStroke.Thickness = 1
            colorBtnStroke.Parent = colorBtn
            
            -- FIXED: Dynamic color glow
            local colorBtnGlow = AddGlow(colorBtn, default, 12, 0.6)
            
            -- Color picker popup
            local pickerFrame = Instance.new("Frame")
            pickerFrame.Size = UDim2.new(0, 200, 0, 170)
            pickerFrame.BackgroundColor3 = Theme.Secondary
            pickerFrame.Visible = false
            pickerFrame.ZIndex = 101
            pickerFrame.Parent = OverlayContainer
            
            local pickerCorner = Instance.new("UICorner")
            pickerCorner.CornerRadius = UDim.new(0, 6)
            pickerCorner.Parent = pickerFrame
            
            local pickerStroke = Instance.new("UIStroke")
            pickerStroke.Color = Theme.Border
            pickerStroke.Thickness = 1
            pickerStroke.Parent = pickerFrame
            
            AddShadow(pickerFrame, 0.3)
            
            -- Saturation/Value picker
            local svPicker = Instance.new("ImageLabel")
            svPicker.Size = UDim2.new(1, -20, 0, 100)
            svPicker.Position = UDim2.new(0, 10, 0, 10)
            svPicker.BackgroundColor3 = Color3.fromHSV(0, 1, 1)
            svPicker.BorderSizePixel = 0
            svPicker.Image = "rbxassetid://4155801252"
            svPicker.ZIndex = 102
            svPicker.Parent = pickerFrame
            
            local svCorner = Instance.new("UICorner")
            svCorner.CornerRadius = UDim.new(0, 4)
            svCorner.Parent = svPicker
            
            local svCursor = Instance.new("Frame")
            svCursor.Size = UDim2.new(0, 10, 0, 10)
            svCursor.Position = UDim2.new(1, -5, 0, -5)
            svCursor.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            svCursor.BorderSizePixel = 0
            svCursor.ZIndex = 103
            svCursor.Parent = svPicker
            
            local svCursorCorner = Instance.new("UICorner")
            svCursorCorner.CornerRadius = UDim.new(1, 0)
            svCursorCorner.Parent = svCursor
            
            local svCursorStroke = Instance.new("UIStroke")
            svCursorStroke.Color = Color3.fromRGB(0, 0, 0)
            svCursorStroke.Thickness = 1
            svCursorStroke.Parent = svCursor
            
            -- Hue slider
            local huePicker = Instance.new("ImageLabel")
            huePicker.Size = UDim2.new(1, -20, 0, 16)
            huePicker.Position = UDim2.new(0, 10, 0, 115)
            huePicker.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            huePicker.BorderSizePixel = 0
            huePicker.Image = "rbxassetid://3641079629"
            huePicker.ZIndex = 102
            huePicker.Parent = pickerFrame
            
            local hueCorner = Instance.new("UICorner")
            hueCorner.CornerRadius = UDim.new(0, 4)
            hueCorner.Parent = huePicker
            
            local hueCursor = Instance.new("Frame")
            hueCursor.Size = UDim2.new(0, 4, 1, 4)
            hueCursor.Position = UDim2.new(0, -2, 0, -2)
            hueCursor.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            hueCursor.BorderSizePixel = 0
            hueCursor.ZIndex = 103
            hueCursor.Parent = huePicker
            
            local hueCursorStroke = Instance.new("UIStroke")
            hueCursorStroke.Color = Color3.fromRGB(0, 0, 0)
            hueCursorStroke.Thickness = 1
            hueCursorStroke.Parent = hueCursor
            
            -- RGB inputs
            local rgbContainer = Instance.new("Frame")
            rgbContainer.Size = UDim2.new(1, -20, 0, 22)
            rgbContainer.Position = UDim2.new(0, 10, 0, 138)
            rgbContainer.BackgroundTransparency = 1
            rgbContainer.ZIndex = 102
            rgbContainer.Parent = pickerFrame
            
            local function createRGBInput(labelText, posX)
                local lbl = Instance.new("TextLabel")
                lbl.Size = UDim2.new(0, 12, 1, 0)
                lbl.Position = UDim2.new(0, posX, 0, 0)
                lbl.BackgroundTransparency = 1
                lbl.Font = Enum.Font.Arcade
                lbl.Text = labelText
                lbl.TextColor3 = Theme.TextDark
                lbl.TextSize = 9
                lbl.ZIndex = 103
                lbl.Parent = rgbContainer
                
                local box = Instance.new("TextBox")
                box.Size = UDim2.new(0, 35, 1, 0)
                box.Position = UDim2.new(0, posX + 14, 0, 0)
                box.BackgroundColor3 = Theme.Tertiary
                box.BorderSizePixel = 0
                box.Font = Enum.Font.Arcade
                box.Text = "255"
                box.TextColor3 = Theme.Text
                box.TextSize = 9
                box.ZIndex = 103
                box.Parent = rgbContainer
                
                local boxCorner = Instance.new("UICorner")
                boxCorner.CornerRadius = UDim.new(0, 3)
                boxCorner.Parent = box
                
                return box
            end
            
            local rInput = createRGBInput("R", 0)
            local gInput = createRGBInput("G", 58)
            local bInput = createRGBInput("B", 116)
            
            local currentColor = default
            local h, s, v = default:ToHSV()
            local isOpen = false
            local draggingSV = false
            local draggingHue = false
            
            -- FIXED: Proper color update with glow
            local function updateColor()
                currentColor = Color3.fromHSV(h, s, v)
                colorBtn.BackgroundColor3 = currentColor
                colorBtnGlow.ImageColor3 = currentColor -- FIXED: Glow changes color!
                svPicker.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
                
                local r, g, b = math.floor(currentColor.R * 255), math.floor(currentColor.G * 255), math.floor(currentColor.B * 255)
                rInput.Text = tostring(r)
                gInput.Text = tostring(g)
                bInput.Text = tostring(b)
                
                callback(currentColor)
            end
            
            local function updateCursors()
                svCursor.Position = UDim2.new(s, -5, 1 - v, -5)
                hueCursor.Position = UDim2.new(h, -2, 0, -2)
            end
            
            local function updatePickerPosition()
                local absPos = colorBtn.AbsolutePosition
                local absSize = colorBtn.AbsoluteSize
                local screenSize = workspace.CurrentCamera.ViewportSize
                
                local x = absPos.X
                local y = absPos.Y + absSize.Y + 4
                
                if x + 200 > screenSize.X then
                    x = absPos.X + absSize.X - 200
                end
                if y + 170 > screenSize.Y then
                    y = absPos.Y - 174
                end
                
                pickerFrame.Position = UDim2.new(0, x, 0, y)
            end
            
            updateCursors()
            
            colorBtn.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                if isOpen then
                    updatePickerPosition()
                    pickerFrame.Visible = true
                else
                    pickerFrame.Visible = false
                end
            end)
            
            svPicker.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    draggingSV = true
                end
            end)
            
            svPicker.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    draggingSV = false
                end
            end)
            
            huePicker.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    draggingHue = true
                end
            end)
            
            huePicker.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    draggingHue = false
                end
            end)
            
            -- FIXED: Smooth dragging
            UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement then
                    if draggingSV then
                        local pos = Vector2.new(input.Position.X, input.Position.Y)
                        local relX = math.clamp((pos.X - svPicker.AbsolutePosition.X) / svPicker.AbsoluteSize.X, 0, 1)
                        local relY = math.clamp((pos.Y - svPicker.AbsolutePosition.Y) / svPicker.AbsoluteSize.Y, 0, 1)
                        s = relX
                        v = 1 - relY
                        updateCursors()
                        updateColor()
                    elseif draggingHue then
                        local pos = input.Position.X
                        h = math.clamp((pos - huePicker.AbsolutePosition.X) / huePicker.AbsoluteSize.X, 0, 1)
                        updateCursors()
                        updateColor()
                    end
                end
            end)
            
            -- RGB input handling
            local function handleRGBInput()
                local r = math.clamp(tonumber(rInput.Text) or 0, 0, 255)
                local g = math.clamp(tonumber(gInput.Text) or 0, 0, 255)
                local b = math.clamp(tonumber(bInput.Text) or 0, 0, 255)
                
                currentColor = Color3.fromRGB(r, g, b)
                h, s, v = currentColor:ToHSV()
                colorBtn.BackgroundColor3 = currentColor
                colorBtnGlow.ImageColor3 = currentColor
                svPicker.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
                updateCursors()
                callback(currentColor)
            end
            
            rInput.FocusLost:Connect(handleRGBInput)
            gInput.FocusLost:Connect(handleRGBInput)
            bInput.FocusLost:Connect(handleRGBInput)
            
            -- Close when clicking elsewhere
            UserInputService.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 and isOpen then
                    task.wait()
                    local mousePos = UserInputService:GetMouseLocation()
                    local pickerPos = pickerFrame.AbsolutePosition
                    local pickerSize = pickerFrame.AbsoluteSize
                    local btnPos = colorBtn.AbsolutePosition
                    local btnSize = colorBtn.AbsoluteSize
                    
                    local inPicker = mousePos.X >= pickerPos.X and mousePos.X <= pickerPos.X + pickerSize.X and
                                     mousePos.Y >= pickerPos.Y and mousePos.Y <= pickerPos.Y + pickerSize.Y
                    local inBtn = mousePos.X >= btnPos.X and mousePos.X <= btnPos.X + btnSize.X and
                                  mousePos.Y >= btnPos.Y and mousePos.Y <= btnPos.Y + btnSize.Y
                    
                    if not inPicker and not inBtn then
                        isOpen = false
                        pickerFrame.Visible = false
                    end
                end
            end)
            
            local ColorPicker = {}
            function ColorPicker:Set(color)
                currentColor = color
                h, s, v = color:ToHSV()
                colorBtn.BackgroundColor3 = color
                colorBtnGlow.ImageColor3 = color
                svPicker.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
                updateCursors()
                local r, g, b = math.floor(color.R * 255), math.floor(color.G * 255), math.floor(color.B * 255)
                rInput.Text = tostring(r)
                gInput.Text = tostring(g)
                bInput.Text = tostring(b)
                callback(color)
            end
            function ColorPicker:Get() return currentColor end
            
            return ColorPicker
        end
        
        -- Keybind
        function Tab:CreateKeybind(options)
            local name = options.Name or "Keybind"
            local default = options.Default or Enum.KeyCode.Unknown
            local callback = options.Callback or function() end
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local container = Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 26)
            container.BackgroundTransparency = 1
            container.LayoutOrder = order
            container.Parent = parent
            
            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -60, 1, 0)
            label.BackgroundTransparency = 1
            label.Font = Enum.Font.Arcade
            label.Text = name
            label.TextColor3 = Theme.Text
            label.TextSize = 10
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = container
            
            local keyBtn = Instance.new("TextButton")
            keyBtn.Size = UDim2.new(0, 50, 0, 20)
            keyBtn.Position = UDim2.new(1, -50, 0.5, -10)
            keyBtn.BackgroundColor3 = Theme.Tertiary
            keyBtn.BorderSizePixel = 0
            keyBtn.Font = Enum.Font.Arcade
            keyBtn.Text = default.Name
            keyBtn.TextColor3 = Theme.Text
            keyBtn.TextSize = 9
            keyBtn.Parent = container
            
            local keyBtnCorner = Instance.new("UICorner")
            keyBtnCorner.CornerRadius = UDim.new(0, 4)
            keyBtnCorner.Parent = keyBtn
            
            local keyBtnStroke = Instance.new("UIStroke")
            keyBtnStroke.Color = Theme.Border
            keyBtnStroke.Thickness = 1
            keyBtnStroke.Parent = keyBtn
            
            local currentKey = default
            local listening = false
            
            keyBtn.MouseButton1Click:Connect(function()
                listening = true
                keyBtn.Text = "..."
            end)
            
            UserInputService.InputBegan:Connect(function(input, processed)
                if listening and input.UserInputType == Enum.UserInputType.Keyboard then
                    currentKey = input.KeyCode
                    keyBtn.Text = input.KeyCode.Name
                    listening = false
                elseif not processed and input.KeyCode == currentKey then
                    callback(currentKey)
                end
            end)
            
            local Keybind = {}
            function Keybind:Set(key)
                currentKey = key
                keyBtn.Text = key.Name
            end
            function Keybind:Get() return currentKey end
            
            return Keybind
        end
        
        -- Label
        function Tab:CreateLabel(options)
            local text = options.Text or "Label"
            local parent = options.Section or page
            local order = options.LayoutOrder or (SectionOrder + 1)
            
            local lbl = Instance.new("TextLabel")
            lbl.Size = UDim2.new(1, 0, 0, 18)
            lbl.BackgroundTransparency = 1
            lbl.Font = Enum.Font.Arcade
            lbl.Text = text
            lbl.TextColor3 = Theme.TextDark
            lbl.TextSize = 10
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.LayoutOrder = order
            lbl.Parent = parent
            
            local Label = {}
            function Label:Set(newText) lbl.Text = newText end
            return Label
        end
        
        return Tab
    end
    
    function Window:Destroy() Main:Destroy() end
    function Window:Toggle(visible) Main.Visible = visible end
    
    return Window
end

return Cohoes
