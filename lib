local Cohoes = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Theme
local Theme = {
    Background = Color3.fromRGB(10, 10, 10),
    Secondary = Color3.fromRGB(18, 18, 18),
    Tertiary = Color3.fromRGB(30, 30, 30),
    Accent = Color3.fromRGB(255, 255, 255),
    AccentDark = Color3.fromRGB(200, 200, 200),
    Text = Color3.fromRGB(255, 255, 255),
    TextDark = Color3.fromRGB(120, 120, 120),
    Success = Color3.fromRGB(100, 255, 150),
    Warning = Color3.fromRGB(255, 200, 100),
    Error = Color3.fromRGB(255, 100, 100),
    Border = Color3.fromRGB(60, 60, 60),
    Glow = Color3.fromRGB(255, 255, 255),
    Shadow = Color3.fromRGB(0, 0, 0)
}

Cohoes.Theme = Theme

-- Helper function to add glow effect
local function AddGlow(element, color, size, transparency)
    local glow = Instance.new("ImageLabel")
    glow.Name = "Glow"
    glow.BackgroundTransparency = 1
    glow.Size = UDim2.new(1, size or 20, 1, size or 20)
    glow.Position = UDim2.new(0.5, 0, 0.5, 0)
    glow.AnchorPoint = Vector2.new(0.5, 0.5)
    glow.Image = "rbxassetid://5028857084"
    glow.ImageColor3 = color or Theme.Glow
    glow.ImageTransparency = transparency or 0.7
    glow.ZIndex = element.ZIndex - 1
    glow.Parent = element
    return glow
end

-- Helper function to add drop shadow
local function AddShadow(element, transparency)
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.BackgroundTransparency = 1
    shadow.Size = UDim2.new(1, 30, 1, 30)
    shadow.Position = UDim2.new(0.5, 0, 0.5, 2)
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.Image = "rbxassetid://5028857084"
    shadow.ImageColor3 = Theme.Shadow
    shadow.ImageTransparency = transparency or 0.5
    shadow.ZIndex = element.ZIndex - 1
    shadow.Parent = element
    return shadow
end

-- Smooth tween helper
function Cohoes:tween(obj, properties, easingStyle, time)
    local tween = TweenService:Create(
        obj,
        TweenInfo.new(
            time or 0.25,
            easingStyle or Enum.EasingStyle.Quint,
            Enum.EasingDirection.InOut,
            0,
            false,
            0
        ),
        properties
    )
    tween:Play()
    return tween
end

-- Screen GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CohoesUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- FIX: Better GUI protection with error handling
local function ProtectGui()
    local success, err = pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(ScreenGui)
            ScreenGui.Parent = game.CoreGui
        elseif gethui then
            ScreenGui.Parent = gethui()
        else
            ScreenGui.Parent = game.CoreGui
        end
    end)
    
    if not success then
        warn("Cohoes UI: Failed to protect GUI - " .. tostring(err))
        -- Fallback: try PlayerGui
        pcall(function()
            ScreenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
        end)
    end
end

ProtectGui()

-- Dropdown overlay container
local OverlayContainer = Instance.new("Frame")
OverlayContainer.Name = "OverlayContainer"
OverlayContainer.Size = UDim2.new(1, 0, 1, 0)
OverlayContainer.BackgroundTransparency = 1
OverlayContainer.ZIndex = 100
OverlayContainer.Parent = ScreenGui

-- Notification System
local NotifHolder = Instance.new("Frame")
NotifHolder.Name = "Notifications"
NotifHolder.Size = UDim2.new(0, 300, 1, -40)
NotifHolder.Position = UDim2.new(1, -310, 0, 20)
NotifHolder.BackgroundTransparency = 1
NotifHolder.ZIndex = 200
NotifHolder.Parent = ScreenGui

local NotifLayout = Instance.new("UIListLayout")
NotifLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifLayout.Padding = UDim.new(0, 6)
NotifLayout.VerticalAlignment = Enum.VerticalAlignment.Top
NotifLayout.Parent = NotifHolder

function Cohoes:Notify(options)
    local title = options.Title or "Notification"
    local message = options.Message or ""
    local duration = options.Duration or 3
    
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(1, 0, 0, 55)
    notif.BackgroundColor3 = Theme.Secondary
    notif.BorderSizePixel = 0
    notif.Position = UDim2.new(1, 20, 0, 0)
    notif.ZIndex = 201
    notif.Parent = NotifHolder
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = notif
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Theme.Border
    stroke.Thickness = 1
    stroke.Parent = notif
    
    local glow = AddGlow(notif, Theme.Accent, 25, 0.5)
    
    -- Pulsing animation
    spawn(function()
        while notif.Parent do
            Cohoes:tween(glow, {ImageTransparency = 0.3}, Enum.EasingStyle.Sine, 1)
            wait(1)
            if notif.Parent then
                Cohoes:tween(glow, {ImageTransparency = 0.6}, Enum.EasingStyle.Sine, 1)
                wait(1)
            end
        end
    end)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -16, 0, 20)
    titleLabel.Position = UDim2.new(0, 8, 0, 6)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.Gotham
    titleLabel.Text = title
    titleLabel.TextColor3 = Theme.Text
    titleLabel.TextSize = 12
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.ZIndex = 202
    titleLabel.Parent = notif
    
    local msgLabel = Instance.new("TextLabel")
    msgLabel.Size = UDim2.new(1, -16, 0, 18)
    msgLabel.Position = UDim2.new(0, 8, 0, 26)
    msgLabel.BackgroundTransparency = 1
    msgLabel.Font = Enum.Font.Gotham
    msgLabel.Text = message
    msgLabel.TextColor3 = Theme.TextDark
    msgLabel.TextSize = 10
    msgLabel.TextXAlignment = Enum.TextXAlignment.Left
    msgLabel.TextTruncate = Enum.TextTruncate.AtEnd
    msgLabel.ZIndex = 202
    msgLabel.Parent = notif
    
    local progressBg = Instance.new("Frame")
    progressBg.Size = UDim2.new(1, 0, 0, 2)
    progressBg.Position = UDim2.new(0, 0, 1, -2)
    progressBg.BackgroundColor3 = Theme.Tertiary
    progressBg.BorderSizePixel = 0
    progressBg.ZIndex = 202
    progressBg.Parent = notif
    
    local progress = Instance.new("Frame")
    progress.Size = UDim2.new(1, 0, 1, 0)
    progress.BackgroundColor3 = Theme.Accent
    progress.BorderSizePixel = 0
    progress.ZIndex = 203
    progress.Parent = progressBg
    
    Cohoes:tween(notif, {Position = UDim2.new(0, 0, 0, 0)}, Enum.EasingStyle.Quart, 0.3)
    Cohoes:tween(progress, {Size = UDim2.new(0, 0, 1, 0)}, Enum.EasingStyle.Linear, duration)
    
    task.delay(duration, function()
        Cohoes:tween(notif, {Position = UDim2.new(1, 20, 0, 0)}, Enum.EasingStyle.Quart, 0.3)
        task.wait(0.35)
        notif:Destroy()
    end)
end

-- Window Creation
function Cohoes:CreateWindow(options)
    local Window = {}
    
    local title = options.Title or "Cohoes UI"
    local size = options.Size or {500, 400}
    local toggleKey = options.ToggleKey or Enum.KeyCode.RightShift
    
    local Main = Instance.new("Frame")
    Main.Name = "MainWindow"
    Main.Size = UDim2.new(0, size[1], 0, size[2])
    Main.Position = UDim2.new(0.5, -size[1]/2, 0.5, -size[2]/2)
    Main.BackgroundColor3 = Theme.Background
    Main.BorderSizePixel = 0
    Main.Parent = ScreenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = Main
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Theme.Border
    mainStroke.Thickness = 1
    mainStroke.Parent = Main
    
    local mainShadow = AddShadow(Main, 0.2)
    mainShadow.Size = UDim2.new(1, 60, 1, 60)
    
    -- Header
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 32)
    Header.BackgroundColor3 = Theme.Secondary
    Header.BorderSizePixel = 0
    Header.Parent = Main
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 6)
    headerCorner.Parent = Header
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 10)
    headerFix.Position = UDim2.new(0, 0, 1, -10)
    headerFix.BackgroundColor3 = Theme.Secondary
    headerFix.BorderSizePixel = 0
    headerFix.Parent = Header
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -70, 1, 0)
    titleLabel.Position = UDim2.new(0, 12, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = string.upper(title)
    titleLabel.TextColor3 = Theme.Text
    titleLabel.TextSize = 12
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = Header
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 20, 0, 20)
    closeBtn.Position = UDim2.new(1, -28, 0.5, -10)
    closeBtn.BackgroundColor3 = Theme.Tertiary
    closeBtn.BorderSizePixel = 0
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Theme.TextDark
    closeBtn.TextSize = 14
    closeBtn.Parent = Header
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 4)
    closeBtnCorner.Parent = closeBtn
    
    local closeBtnGlow = AddGlow(closeBtn, Theme.Error, 15, 1)
    
    closeBtn.MouseEnter:Connect(function()
        Cohoes:tween(closeBtn, {BackgroundColor3 = Theme.Error}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(closeBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.15)
    end)
    closeBtn.MouseLeave:Connect(function()
        Cohoes:tween(closeBtn, {BackgroundColor3 = Theme.Tertiary}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(closeBtnGlow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
    end)
    closeBtn.MouseButton1Click:Connect(function()
        Main.Visible = false
    end)
    
    -- Minimize button
    local minBtn = Instance.new("TextButton")
    minBtn.Size = UDim2.new(0, 20, 0, 20)
    minBtn.Position = UDim2.new(1, -52, 0.5, -10)
    minBtn.BackgroundColor3 = Theme.Tertiary
    minBtn.BorderSizePixel = 0
    minBtn.Font = Enum.Font.GothamBold
    minBtn.Text = "−"
    minBtn.TextColor3 = Theme.TextDark
    minBtn.TextSize = 14
    minBtn.Parent = Header
    
    local minBtnCorner = Instance.new("UICorner")
    minBtnCorner.CornerRadius = UDim.new(0, 4)
    minBtnCorner.Parent = minBtn
    
    local minBtnGlow = AddGlow(minBtn, Theme.Warning, 15, 1)
    
    minBtn.MouseEnter:Connect(function()
        Cohoes:tween(minBtn, {BackgroundColor3 = Theme.Warning}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(minBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.15)
    end)
    minBtn.MouseLeave:Connect(function()
        Cohoes:tween(minBtn, {BackgroundColor3 = Theme.Tertiary}, Enum.EasingStyle.Quart, 0.15)
        Cohoes:tween(minBtnGlow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
    end)
    
    -- Tab sidebar
    local TabSidebar = Instance.new("Frame")
    TabSidebar.Name = "TabSidebar"
    TabSidebar.Size = UDim2.new(0, 100, 1, -40)
    TabSidebar.Position = UDim2.new(0, 4, 0, 36)
    TabSidebar.BackgroundColor3 = Theme.Secondary
    TabSidebar.BorderSizePixel = 0
    TabSidebar.Parent = Main
    
    local sidebarCorner = Instance.new("UICorner")
    sidebarCorner.CornerRadius = UDim.new(0, 4)
    sidebarCorner.Parent = TabSidebar
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 2)
    tabLayout.Parent = TabSidebar
    
    local tabPadding = Instance.new("UIPadding")
    tabPadding.PaddingTop = UDim.new(0, 4)
    tabPadding.PaddingLeft = UDim.new(0, 4)
    tabPadding.PaddingRight = UDim.new(0, 4)
    tabPadding.Parent = TabSidebar
    
    -- Content container
    local ContentContainer = Instance.new("Frame")
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Size = UDim2.new(1, -116, 1, -40)
    ContentContainer.Position = UDim2.new(0, 110, 0, 36)
    ContentContainer.BackgroundTransparency = 1
    ContentContainer.ClipsDescendants = true
    ContentContainer.Parent = Main
    
    -- Dragging
    local dragging, dragStart, startPos = false, nil, nil
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    -- Toggle key
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        if input.KeyCode == toggleKey then
            Main.Visible = not Main.Visible
        end
    end)
    
    -- Minimize
    local minimized = false
    minBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            Cohoes:tween(Main, {Size = UDim2.new(0, size[1], 0, 32)}, Enum.EasingStyle.Quart, 0.3)
            ContentContainer.Visible = false
            TabSidebar.Visible = false
        else
            Cohoes:tween(Main, {Size = UDim2.new(0, size[1], 0, size[2])}, Enum.EasingStyle.Quart, 0.3)
            task.wait(0.15)
            ContentContainer.Visible = true
            TabSidebar.Visible = true
        end
    end)
    
    local Tabs = {}
    local CurrentTab = nil
    local TabCount = 0
    
    function Window:CreateTab(name)
        local Tab = {}
        TabCount = TabCount + 1
        
        local tabBtn = Instance.new("TextButton")
        tabBtn.Name = name
        tabBtn.Size = UDim2.new(1, 0, 0, 28)
        tabBtn.BackgroundColor3 = Theme.Tertiary
        tabBtn.BackgroundTransparency = 1
        tabBtn.BorderSizePixel = 0
        tabBtn.Font = Enum.Font.Gotham
        tabBtn.Text = string.upper(name)
        tabBtn.TextColor3 = Theme.TextDark
        tabBtn.TextSize = 10
        tabBtn.LayoutOrder = TabCount
        tabBtn.Parent = TabSidebar
        
        local tabBtnCorner = Instance.new("UICorner")
        tabBtnCorner.CornerRadius = UDim.new(0, 4)
        tabBtnCorner.Parent = tabBtn
        
        local tabBtnGlow = AddGlow(tabBtn, Theme.Accent, 20, 1)
        
        local page = Instance.new("ScrollingFrame")
        page.Name = name .. "Page"
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1
        page.BorderSizePixel = 0
        page.ScrollBarThickness = 3
        page.ScrollBarImageColor3 = Theme.TextDark
        page.CanvasSize = UDim2.new(0, 0, 0, 0)
        page.Visible = false
        page.Parent = ContentContainer
        
        local pageLayout = Instance.new("UIListLayout")
        pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
        pageLayout.Padding = UDim.new(0, 6)
        pageLayout.Parent = page
        
        local function updateCanvasSize()
            task.wait(0.1)
            local contentSize = pageLayout.AbsoluteContentSize.Y
            page.CanvasSize = UDim2.new(0, 0, 0, contentSize + 10)
        end
        
        pageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)
        
        Tabs[name] = {btn = tabBtn, page = page, layout = pageLayout, glow = tabBtnGlow, updateCanvas = updateCanvasSize}
        
        tabBtn.MouseButton1Click:Connect(function()
            if CurrentTab and Tabs[CurrentTab] then
                Cohoes:tween(Tabs[CurrentTab].btn, {TextColor3 = Theme.TextDark, BackgroundTransparency = 1}, Enum.EasingStyle.Quart, 0.2)
                Cohoes:tween(Tabs[CurrentTab].glow, {ImageTransparency = 1}, Enum.EasingStyle.Quart, 0.2)
                Tabs[CurrentTab].page.Visible = false
            end
            CurrentTab = name
            Cohoes:tween(tabBtn, {TextColor3 = Theme.Text, BackgroundTransparency = 0}, Enum.EasingStyle.Quart, 0.2)
            Cohoes:tween(tabBtnGlow, {ImageTransparency = 0.4}, Enum.EasingStyle.Quart, 0.2)
            page.Visible = true
            updateCanvasSize()
        end)
        
        tabBtn.MouseEnter:Connect(function()
            if CurrentTab ~= name then
                Cohoes:tween(tabBtn, {BackgroundTransparency = 0.5}, Enum.EasingStyle.Quart, 0.15)
            end
        end)
        tabBtn.MouseLeave:Connect(function()
            if CurrentTab ~= name then
                Cohoes:tween(tabBtn, {BackgroundTransparency = 1}, Enum.EasingStyle.Quart, 0.15)
            end
        end)
        
        if TabCount == 1 then
            task.wait(0.05)
            tabBtn.TextColor3 = Theme.Text
            tabBtn.BackgroundTransparency = 0
            tabBtnGlow.ImageTransparency = 0.4
            page.Visible = true
            CurrentTab = name
            updateCanvasSize()
        end
        
        -- Sections and elements would go here (keeping your existing code)
        -- I'm including a simplified version for testing
        
        function Tab:CreateButton(options)
            local name = options.Name or "Button"
            local callback = options.Callback or function() end
            
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 28)
            btn.BackgroundColor3 = Theme.Tertiary
            btn.BorderSizePixel = 0
            btn.Font = Enum.Font.Gotham
            btn.Text = name
            btn.TextColor3 = Theme.Text
            btn.TextSize = 10
            btn.Parent = page
            
            local btnCorner = Instance.new("UICorner")
            btnCorner.CornerRadius = UDim.new(0, 4)
            btnCorner.Parent = btn
            
            btn.MouseButton1Click:Connect(callback)
            
            updateCanvasSize()
        end
        
        return Tab
    end
    
    function Window:Destroy() Main:Destroy() end
    function Window:Toggle(visible) Main.Visible = visible end
    
    return Window
end

-- FIX: Add initialization check
print("Cohoes UI Library loaded successfully!")

return Cohoes
